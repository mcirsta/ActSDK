#**************************************************************************
#                                                                         *
#   PROJECT     : MIPS port for UCOS-II                                   *
#                                                                         *
#   MODULE      : MakeFile rules for building static library              *
#                                                                         *
#   AUTHOR      :                                                         *
#                                                                         *
#   PROCESSOR   : MIPS 4KEc (32 bit RISC) - Actions board                 *
#                                                                         *
#   Tool-chain  :  Cygnus                                                 *
#                                                                         *
#   DESCRIPTION :                                                         *
#   Makefile rules used for building static library.                      *
#                                                                         *
#   The default target (all) builds application in two formats :          *
#   *.elf : Image in ELF format.                                          *
#   *.rec : Image in S-record format.                                     *
#                                                                         *
#   The linker also generates a MAP file "*.map".                         *
#                                                                         *
#   Other targets are :                                                   *
#   clean :    Deletes all files generated by makefile.                   *
#   depend :   Builds dependency file.                                    *
#                                                                         *
#*************************************************************************/

CC        = sde-gcc
LD        = sde-ld
OBJCOPY   = sde-objcopy
OBJDUMP   = sde-objdump
AR        = sde-ar

# **********************************************
# Endianness
# **********************************************

ENDIAN  = EL

ifeq ($(ENDIAN),EL)
OFORMAT = -EL
else
OFORMAT = -EB
endif

# **********************************************
# Type of Processor & Board
# **********************************************

Processor = mips

# **********************************************
# Directories
# **********************************************

CASEROOT  = $(ROOT)/case
PSPROOT   = $(ROOT)/psp_rel

INCDIR    = $(PSPROOT)/include $(PSPROOT)/include/libc \
            $(CASEROOT)/include
LINKDIR   = .
SRCDIR    = .

include $(PSPROOT)/config/config.cfg
include $(CASEROOT)/include/case.xn

# **********************************************
# Image file names and map file
# **********************************************

IMAGE_ELF = $(IMAGENAME).a

# **********************************************
# print options
# **********************************************

print= err

PRINT_ERR = -DPRINT_ERR=0
PRINT_WARN = -DPRINT_WARN=0
PRINT_DBG = -DPRINT_DBG=0
PRINT_INFO = -DPRINT_INFO=0
PRINT_TIME = -DPRINT_TIME=0

ifeq ($(print),all)
PRINT_ERR = -DPRINT_ERR=1
PRINT_WARN = -DPRINT_WARN=1
PRINT_DBG = -DPRINT_DBG=1
PRINT_INFO = -DPRINT_INFO=1
PRINT_TIME = -DPRINT_TIME=1
endif

ifeq ($(print),off)
PRINT_ERR = -DPRINT_ERR=1
PRINT_WARN = -DPRINT_WARN=0
PRINT_DBG = -DPRINT_DBG=0
PRINT_INFO = -DPRINT_INFO=0
PRINT_TIME = -DPRINT_TIME=0
endif

ifeq ($(findstring err, $(print)), err)
PRINT_ERR = -DPRINT_ERR=1
endif

ifeq ($(findstring warn, $(print)), warn)
PRINT_WARN = -DPRINT_WARN=1
endif

ifeq ($(findstring dbg, $(print)), dbg)
PRINT_DBG = -DPRINT_DBG=1
endif

ifeq ($(findstring info, $(print)), info)
PRINT_INFO = -DPRINT_INFO=1
endif

ifeq ($(findstring time, $(print)), time)
PRINT_TIME = -DPRINT_TIME=1
endif

PRINT_OPT = $(PRINT_ERR) $(PRINT_WARN) $(PRINT_DBG) $(PRINT_INFO) $(PRINT_TIME)

# **********************************************
# Compiler and linker options
# **********************************************

INCLUDE   = $(foreach dir, $(INCDIR), -I$(dir))
LINCLUDE = -L$(CASEROOT)/include -L$(PSPROOT)/include/xn

CC_OPTS   = -g -O2 -G0 -Wall -Wno-unknown-pragmas $(INCLUDE) -fsigned-char -mtune=4kec -mips32r2 -fno-builtin $(OFORMAT) $(PRINT_OPT)
CC_OPTS_A = $(CC_OPTS) -D_ASSEMBLER_

# **********************************************
# Files to be compiled
# **********************************************

SRCDIR  = ./

SRC_C  = $(foreach dir, $(SRCDIR), $(wildcard $(dir)/*.c))
SRC_S  = $(foreach dir, $(SRCDIR), $(wildcard $(dir)/*.S))

OBJ_C  = $(notdir $(patsubst %.c, %.o, $(SRC_C)))
OBJ_S  = $(notdir $(patsubst %.S, %.o, $(SRC_S)))
OBJ  = $(OBJ_C) $(OBJ_S)

# **********************************************
# Rules
# **********************************************

.PHONY : all
all : $(IMAGE_ELF)

$(IMAGE_ELF) : $(OBJ)
	@echo ¹§Ï²Äú,±àÒë³É¹¦£¡£¨Ð¡¶Ë£©
	$(AR) rcs $(IMAGE_ELF) $(OBJ)  #combine all object file to a lib file
	mv $(IMAGE_ELF) $(IMGDIR)
	rm *.o

$(OBJ_C) : %.o : %.c 
	$(CC) $(CC_OPTS) -c $< -o $@

$(OBJ_S) : %.o : %.S
	$(CC) $(CC_OPTS_A) -c $< -o $@
.PHONY : clean depend

clean :
	rm -f $(LINKDIR)/*.o $(IMGDIR)/$(IMAGE_ELF) $(IMAGE_LST) $(MAP)
	
depend :
	$(CC) $(INCLUDE) -M $(SRC) $(SRC_COM) > $(LINKDIR)/depend.mk

-include depend.mk

