#**************************************************************************
#                                                                         *
#   PROJECT     : MIPS port for UCOS-II                                   *
#                                                                         *
#   MODULE      : MakeFile                                                *
#                                                                         *
#   AUTHOR      : Wurui                                                   *
#                                                                         *
#   PROCESSOR   : MIPS 4KEc (32 bit RISC) - Actions board                 *
#                                                                         *
#   Tool-chain  :  Cygnus                                                 *
#                                                                         *
#   DESCRIPTION :                                                         *
#   Makefile used for building application.                               *
#                                                                         *
#   targets are :                                                         *
#   apps  :    make all applications under case                           *
#   drv  :     make all drivers under case                                *
#   clean :    Deletes all files generated by makefile under case         *
#   depend :   Builds dependency file under case                          *
#                                                                         *
#*************************************************************************/

# **********************************************
# Type of Processor & Board
# **********************************************

Processor = mips

# **********************************************
# Directories
# **********************************************
ROOT      = ./../..
CASEROOT  = $(ROOT)/case
PSP_REL_ROOT = $(ROOT)/psp_rel
APPSROOT  = $(CASEROOT)/apps
LIBSRCROOT = $(CASEROOT)/libsrc
CASE_API_DIR = $(CASEROOT)/lib
APPSDIR   = $(APPSROOT)/config \
	    $(APPSROOT)/process_manager \
	    $(APPSROOT)/msg_server \
	    $(APPSROOT)/usb \
	    $(APPSROOT)/desktop/launcher \
		$(APPSROOT)/desktop/animation_poweroff \
	    $(APPSROOT)/desktop/animation_poweron \
	    $(APPSROOT)/desktop/plist_generate \
	    $(APPSROOT)/desktop/browser \
	    $(APPSROOT)/desktop/camera \
	    $(APPSROOT)/desktop/setting \
	    $(APPSROOT)/desktop/ebook \
	    $(APPSROOT)/desktop/music \
	    $(APPSROOT)/desktop/photo \
	    $(APPSROOT)/desktop/radio \
	    $(APPSROOT)/desktop/recorder \
	    $(APPSROOT)/desktop/emulator\
	    $(APPSROOT)/desktop/stopwatch\
	    $(APPSROOT)/desktop/calculator\
	    $(APPSROOT)/desktop/calendar\
	    $(APPSROOT)/desktop/tvin \
	    $(APPSROOT)/desktop/video \
	    $(APPSROOT)/engine/fm_engine \
	    $(APPSROOT)/engine/music_engine \

LIBSDIR    =$(LIBSRCROOT)/applib  $(CASEROOT)/apps/commonui  $(LIBSRCROOT)/style $(LIBSRCROOT)/loop $(LIBSRCROOT)/fusion
DRVDIR     = 
CASE_API_FILES := $(shell find  $(LIBSDIR) -name '*api.S' )

# **********************************************
# print options
# **********************************************

print= err

PRINT_ERR =
PRINT_WARN =
PRINT_DBG =
PRINT_INFO =
PRINT_TIME =

ifeq ($(print),all)
    PRINT_ERR =err
    PRINT_WARN =warn
    PRINT_DBG =dbg
    PRINT_INFO =info
    PRINT_TIME =time
endif

ifeq ($(print),off)
    PRINT_ERR =err
    PRINT_WARN =
    PRINT_DBG =
    PRINT_INFO =
    PRINT_TIME =
endif

ifeq ($(findstring err, $(print)), err)
    PRINT_ERR =err
endif

ifeq ($(findstring warn, $(print)), warn)
    PRINT_WARN =warn
endif

ifeq ($(findstring dbg, $(print)), dbg)
    PRINT_DBG =dbg
endif

ifeq ($(findstring info, $(print)), info)
    PRINT_INFO =info
endif

ifeq ($(findstring time, $(print)), time)
    PRINT_TIME =time
endif

PRINT_OPT = print=$(PRINT_ERR),$(PRINT_WARN),$(PRINT_DBG),$(PRINT_INFO),$(PRINT_TIME)

# **********************************************
# Rules
# **********************************************

.PHONY : all
all:
	@echo $(PRINT_OPT)
	@echo make nothing,please choose object to make for example : 
	@echo make case_api   //create xxx.a in case/lib/
	@echo make libs	//这是编译全部的应用库\(.a, .so\)
	@echo make apps	//这是编译全部的应用程序\(.app\)	
	@echo make drv	//这是编译在case中的全部的驱动
	@echo make strip //这是使用strip缩小case中的所有应用程序\(.app\)以及共享库\(.so\)

.PHONY : libs applib commonui process_manager msg_server config usb examples apps drv case_api style clean depend strip

applib:
	make -C $(LIBSRCROOT)/applib $(PRINT_OPT)
	@echo 恭喜你编译成功

commonui:
	make -C $(APPSROOT)/commonui $(PRINT_OPT)
	@echo 恭喜你编译成功

process_manager:
	make -C $(APPSROOT)/process_manager $(PRINT_OPT)
	@echo 恭喜你编译成功

msg_server:
	make -C $(APPSROOT)/msg_server $(PRINT_OPT)
	@echo 恭喜你编译成功

config:
	make -C $(APPSROOT)/config $(PRINT_OPT)
	@echo 恭喜你编译成功

usb:
	make -C $(APPSROOT)/usb $(PRINT_OPT)
	@echo 恭喜你编译成功

style:
	make -C $(LIBSRCROOT)/style $(PRINT_OPT)
	@echo 恭喜你编译成功

apps:
	@$(foreach dir, $(APPSDIR), \
	    echo Make -C $(dir);\
	    if [ -d $(dir) ];then \
	    if [ -f $(dir)/Makefile ];then \
	    $(MAKE) -C $(dir) $(PRINT_OPT);\
	    if [ $$? != 0 ]; then \
	    	echo -e `basename $(dir)` "\033[31m  >>>>>>>>>>>>>>>>  编译失败 !!! ";\
		echo -e "\033[37m";\
		sleep 3s; \
	    fi; \
	    else \
	    echo error :Can not find Makefile in $(dir);\
	    fi;\
	    else \
	    echo error :Can not find directory $(dir);\
	    fi;\
	    echo end;\
	    echo;\
	    )

libs:
	@$(foreach dir, $(LIBSDIR), \
	    echo Make -C $(dir) ;\
	    if [ -d $(dir) ];then \
	    if [ -f $(dir)/Makefile ];then \
	    $(MAKE) -C $(dir) $(PRINT_OPT);\
	    if [ $$? != 0 ]; then \
	    	echo -e `basename $(dir)` "\033[31m  >>>>>>>>>>>>>>>>  编译失败 !!! ";\
		echo -e "\033[37m";\
		sleep 3s; \
            fi; \
	    else \
	    echo error :Can not find Makefile in $(dir);\
	    fi;\
	    else \
	    echo error :Can not find directory $(dir);\
	    fi;\
	    echo end;\
	    echo;\
	    )

	$(MAKE) -C  $(APPSROOT)/desktop/launcher libs $(PRINT_OPT)
	@if [ $$? != 0 ]; then \
		echo -e `basename $(dir)` "\033[31m  >>>>>>>>>>>>>>>>  编译失败 !!! ";\
		echo -e "\033[37m";\
		sleep 3s; \
		fi;
		

drv:
	@$(foreach dir, $(DRVDIR), \
	    echo Make -C $(dir) ;\
	    if [ -d $(dir) ];then \
	    if [ -f $(dir)/Makefile ];then \
	    $(MAKE) -C $(dir) $(PRINT_OPT) ;\
	    if [ $$? != 0 ]; then \
	    	echo -e `basename $(dir)` "\033[31m  >>>>>>>>>>>>>>>>  编译失败 !!! ";\
		echo -e "\033[37m";\
		sleep 3s; \
            fi; \
	    else \
	    echo error :Can not find Makefile in $(dir);\
	    fi;\
	    else \
	    echo error :Can not find directory $(dir);\
	    fi;\
	    echo end;\
	    echo;\
	    )

# Usage: ./create_lib.sh  idir  [odir]  [sdkdir]
# idir: input api file name with path, such as usdk130/dev/sdk/kernel/mips/os_api.S
# odir: output dir for api.a, such as usdk130/sdk/lib
# sdkdir: dir for sdk locate in, such as usdk130/

case_api:
	for api_file in $(CASE_API_FILES); do ./create_api.sh  $$api_file  $(CASE_API_DIR) $(PSP_REL_ROOT); done
	$(MAKE) -C  $(APPSROOT)/desktop/launcher api 

clean :
	@$(foreach dir, $(LIBSDIR) $(APPSDIR) $(DRVDIR), \
	    echo Make clean -C $(dir);\
	    if [ -d $(dir) ];then \
	    if [ -f $(dir)/Makefile ];then \
	    $(MAKE) clean -C $(dir);\
	    else \
	    echo error :Can not find Makefile in $(dir);\
	    fi;\
	    else \
	    echo error :Can not find directory $(dir);\
	    fi;\
	    echo end;\
	    echo;\
	    )
depend :
	@$(foreach dir, $(LIBSDIR) $(APPSDIR) $(DRVDIR), \
	    echo Make depend -C $(dir);\
	    if [ -d $(dir) ];then \
	    if [ -f $(dir)/Makefile ];then \
	    $(MAKE) depend -C $(dir);\
	    else \
	    echo error :Can not find Makefile in $(dir);\
	    fi;\
	    else \
	    echo error :Can not find directory $(dir);\
	    fi;\
	    echo end;\
	    echo;\
	    )

strip:
	@$(foreach dir, $(APPSDIR), \
	    echo Make -C $(dir);\
	    if [ -d $(dir) ];then \
	    if [ -f $(dir)/Makefile ];then \
	    $(MAKE) -C $(dir) strip;\
	    if [ $$? != 0 ]; then \
	    	echo -e `basename $(dir)` "\033[31m  >>>>>>>>>>>>>>>>  strip失败 !!! ";\
		echo -e "\033[37m";\
		sleep 3s; \
	    fi; \
	    else \
	    echo error :Can not find Makefile in $(dir);\
	    fi;\
	    else \
	    echo error :Can not find directory $(dir);\
	    fi;\
	    echo end;\
	    echo;\
	    )
	@$(foreach dir, $(LIBSDIR), \
	    echo Make -C $(dir) ;\
	    if [ -d $(dir) ];then \
	    if [ -f $(dir)/Makefile ];then \
	    $(MAKE) -C $(dir) strip;\
	    if [ $$? != 0 ]; then \
	    	echo -e `basename $(dir)` "\033[31m  >>>>>>>>>>>>>>>>  strip失败 !!! ";\
		echo -e "\033[37m";\
		sleep 3s; \
            fi; \
	    else \
	    echo error :Can not find Makefile in $(dir);\
	    fi;\
	    else \
	    echo error :Can not find directory $(dir);\
	    fi;\
	    echo end;\
	    echo;\
	    )