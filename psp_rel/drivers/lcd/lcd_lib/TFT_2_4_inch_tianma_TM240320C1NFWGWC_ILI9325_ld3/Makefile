#**************************************************************************
#                                                                         *
#   PROJECT     : MIPS port for UCOS-II                                   *
#                                                                         *
#   MODULE      : MakeFile                                                *
#                                                                         *
#   AUTHOR      :                                                         *
#                                                                         *
#   PROCESSOR   : MIPS 4KEc (32 bit RISC) - Actions board                 *
#                                                                         *
#   Tool-chain  :  Cygnus                                                 *
#                                                                         *
#   DESCRIPTION :                                                         *
#   Makefile used for building application.                               *
#                                                                         *
#   The default target (all) builds application in two formats :          *
#   *.elf : Image in ELF format.                                          *
#   *.rec : Image in S-record format.                                     *
#                                                                         *
#   The linker also generates a MAP file "*.map".                         *
#                                                                         *
#   Other targets are :                                                   *
#   clean :    Deletes all files generated by makefile.                   *
#   depend :   Builds dependency file.                                    *
#                                                                         *
#*************************************************************************/
CC        = sde-gcc
LD        = sde-ld
OBJCOPY   = sde-objcopy
OBJDUMP   = sde-objdump
MV 		  = mv
RM		  = rm -f -r


# **********************************************
# Endianness
# **********************************************

ENDIAN  = EL

ifeq ($(ENDIAN),EL)
OFORMAT = -EL
else
OFORMAT = -EB
endif

# **********************************************
# Type of Processor & Board
# **********************************************
Processor = mips

# **********************************************
# Directories
# **********************************************

CURDIR = $(shell /bin/pwd)/
ROOT   = $(CURDIR)/../../
SDKROOT := $(shell $(ROOT)/config/config.make)
OUTPUT    = $(SDKROOT)/case/images/drv
LIBDIR:=$(SDKROOT)/psp_rel/lib/

include $(SDKROOT)/psp_rel/config/config.cfg
include $(SDKROOT)/case/include/case.xn 
            
MODULE_ADDR = $(LCM_VADDR) 
LCM_TYPE = TFT_2_4_inch_tianma_TM240320C1NFWGWC_ILI9325_ld3
export LCM_TYPE


SDKINCDIR    = $(ROOT)/include
SDKINC    = $(ROOT)/inc

# **********************************************
# Image file names and map file
# **********************************************
IMAGENAME = lcd
IMAGE_DRV = $(IMAGENAME).ko
IMAGE_LST = $(IMAGENAME).lst
IMAGE_REC = $(IMAGENAME).rec
IMAGE_BIN = $(IMAGENAME).bin
MAP       = $(IMAGENAME).map
FULL_NAME = $(IMAGENAME).ko

# **********************************************
# DRV Lib files
# **********************************************

LIBOBJ = $(LIBDIR)/syscall_api.a $(LIBDIR)/kmodule_api.a 

# **********************************************
# Source files
# **********************************************
SRC_H  = include/*.h  lcd_lib/$(LCM_TYPE)/*.h
SRC_C  = $(wildcard *.c)  lcd_lib/$(LCM_TYPE)/lcd_hw.c
SRC    = $(SRC_C) $(SRC_H)

# **********************************************
# Objest files
# **********************************************
OBJ_C  = $(SRC_C:.c=.o)

# ***********************************************
# complile flags
# ***********************************************

INCLUDE   = -Iinclude \
            -I$(SDKINCDIR) \
            -I$(SDKINC) \
            -I./include \
            -I./lcd_lib/$(LCM_TYPE)            

LD_SCRIPT = ko.xn

CC_OPTS   = -O0 -Wall -Wno-unknown-pragmas -G0 $(INCLUDE) -fsigned-char -mtune=4kec -mips32r2 -fno-builtin -DKBUILD_MODNAME=$(FULL_NAME) $(OFORMAT) 
LD_OPTS_1   = -G0 -L$(LIBDIR)/libc -L$(ROOT)/include/xn -T $(LD_SCRIPT) -Ttext $(MODULE_ADDR) $(OFORMAT) 
LD_OPTS_2   = -o $(IMAGE_DRV) -Map $(MAP)

# ***********************************************
# begin to make
# ***********************************************
.PHONY : all
all : $(OBJ_C)
	$(LD) $(LD_OPTS_1) $(OBJ_C) $(LIBOBJ) $(LD_OPTS_2)
	make -C welcome
	@echo ¹§Ï²Äú,±àÒë³É¹¦£¡£¨Ð¡¶Ë£©
	$(OBJDUMP) -D $(IMAGE_DRV) > $(IMAGE_LST)
	$(MV)	$(IMAGE_DRV) $(OUTPUT)
	$(RM) *.ko *.drv  *.bak  *.lst  *.o
	
$(OBJ_C) : %.o : %.c 
	$(CC) $(CC_OPTS) -c $< -o $@

clean : 
	$(RM) *.ko *.drv  *.bak  *.lst *.map *.o *~ include/*~ $(OUTPUT)/$(IMAGE_DRV)
	make -C welcome clean

